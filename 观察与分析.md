# IF4_TP1_Q21a - 观察与分析（简洁）

Q21a 是一个入门级的 FreeRTOS 实验：两个独立任务在 GPIO 上以 busy-loop 快速翻转电平，用示波器与串口观察调度与优先级的影响。

- 配置要点：`oscillo1 = GPIO19`（任务1，优先级1），`oscillo2 = GPIO23`（任务2，优先级10），串口 115200 用于调试输出。

- 代码特点：每个任务在启动时打印核心信息（`xPortGetCoreID()`），随后进入无限循环不断切换输出电平；任务创建使用 `xTaskCreate`，示例故意设置不同优先级以观察抢占效应。

- 预期观察：
  - 若任务被分配到不同核心，两路可并行，示波器上呈现高速方波；
  - 若强制同核（或在单核场景），高优先级任务会抢占 CPU，低优先级任务可能被饿死，导致对应 GPIO 几乎不翻转；
  - 串口打印在并发情况下会竞争，建议使用互斥保护。 

- 简要建议：在任务循环中加入 `vTaskDelay(pdMS_TO_TICKS(n))` 或 `taskYIELD()`，保存任务句柄并使用 mutex 保护串口以便进行可控实验。

基于此，Q21b 将把任务 pin 到同核并保存句柄以放大并演示单核抢占与饿死问题。

## Q21b — 观察与分析（简洁）

- 主要变化：
  - 使用 `xTaskCreatePinnedToCore` 将两个任务固定到核心 0（强制单核运行）。
  - 保存了任务句柄 `Task1` 和 `Task2`（第6个参数传入地址），便于后续控制（挂起、删除、修改优先级）。
  - 每个任务内部包含一个 1000 次的快速翻转循环（busy loop），没有阻塞或延时。
  - 与 Q21a 相比，两个 oscillo 引脚在代码中互换（`oscillo1=23`, `oscillo2=19`）。

- 观察到的事件：
  - 串口输出可能显示两条任务启动信息，并指明它们均运行在 core 0。
  - 在示波器上：当 `task2_prio` 大于 `task1_prio` 时，代表高优先级的任务（对应的 GPIO）会高速翻转；低优先级 GPIO 几乎不变或极少翻转（被饿死）。
  - 若将两个任务设为相同优先级或把高优先级降低，则两路信号会出现交替或时间片轮转的现象。

- 简要分析：
  - 因为任务被固定在同一核心，优先级的抢占效果非常明显：高优先级任务占用 CPU，低优先级任务无法获得运行机会。 
  - 内部 1000 次快速翻转为忙等（busy loop），不会主动让出 CPU；即使循环有有限次数，循环结束后任务仍会立即继续进入下一个循环，保持就绪并继续占用 CPU。
  - 保存任务句柄是一个改进（比 Q21a 直接传 NULL 更灵活），便于后续做实验性操作。

- 建议（短）：
  - 若想避免低优先级任务被饿死，在循环中加入 `vTaskDelay(pdMS_TO_TICKS(x))` 或 `taskYIELD()`。
  - 若想演示多核并行，可将任务不固定到同一核（或分别 pin 到不同核）；若想演示抢占，则 pin 到同一核。
  - 根据任务实际需要调整栈大小，并用任务句柄做可控实验（挂起/恢复/改变优先级）。

为验证并解决 Q21b 中观察到的抢占与饿死问题，Q22a 将引入让出 CPU 与共享资源保护的实验。

## Q22a — 观察与分析（简洁）

- 主要改动：
  - 在任务循环中加入主动阻塞或让出调用（示例：`vTaskDelay(pdMS_TO_TICKS(n))` 或 `taskYIELD()`），使高优先级任务不会无限占用 CPU。
  - 将两个任务在不同实验中设为相同优先级或不同优先级，以观察时间片轮转与抢占两种调度行为的差异。
  - 演示使用任务句柄动态改变优先级、挂起/恢复任务，验证调度器对状态变化的即时响应。
  - 引入对共享串口的互斥保护（例如 FreeRTOS 的 mutex），避免并发打印造成的输出混乱。

- 观察到的事件：
  - 加入 `vTaskDelay` 后，在示波器上两路信号会交替出现，低优先级任务恢复可见的翻转频率；
  - 将优先级调整为相同值时，若在同一核上会观察到时间片轮转导致的近似相同频率；若在不同核上仍会并行且频率接近最大值；
  - 使用 mutex 保护串口后，串口输出变得有序且不再出现明显竞争导致的乱码或丢失。

- 简要分析：
  - `vTaskDelay` 等阻塞调用会把任务置为阻塞态，从而让调度器运行其他就绪任务，避免低优先级任务被完全饿死；
  - 动态改变优先级或挂起任务可以用来演示抢占的即时影响，是理解调度器行为的有力手段；
  - 保护共享资源是并发编程的基本要求，串口 mutex 是一个典型且必要的改进。

- 建议（短）：
  - 在实验中记录不同配置下示波器上两路信号的频率并对比（例如：无延时、1 ms 延时、10 ms 延时）；
  - 调整并测量栈大小以确保任务稳定，避免运行时堆栈溢出；
  - 将部分实验固定到同一核心，部分实验分配到不同核心，直观比较多核并行与单核抢占的差异。
